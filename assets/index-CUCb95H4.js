import{d as C,i as E,f as L,h as P}from"./index-C2-I7XPk.js";import{F as k}from"./index-DkNaNI8o.js";import{a as B,r as m,v as u,K as I,g as O,o as R,c as T,f,w as y,h as N,e as A,i as p,z as F,t as S}from"./index-CBERRbij.js";const U={class:"app-container detection"},z=F({name:"Detection"}),Z=Object.assign(z,{setup(j){const c=B(),{proxy:e}=S(),{order_type:d}=e.useDict("order_type"),n=m(null),i=m(null),g=u(()=>[{type:"input",label:"方案名称",prop:"planName",placeholder:"请输入方案名称"},{type:"select",label:"订单类型",prop:"orderType",placeholder:"请选择订单类型",options:d.value||[]}]),x=u(()=>[{label:"序号",type:"index"},{prop:"planName",label:"方案名称"},{prop:"orderType",label:"订单类型",type:"dict",options:d.value||[]}]),b=[{label:"修改",type:"primary",action:"edit"},{label:"配置",type:"primary",action:"configure"},{label:"复制",type:"primary",action:"copy"},{label:"导出",type:"primary",action:"export"}],_=()=>{c.push({name:"DetectionAdd"})},h=async t=>{e.$prompt("请输入复制后的方案名称","复制检测方案",{confirmButtonText:"确定",cancelButtonText:"取消",inputPattern:/^[\u4e00-\u9fa5_a-zA-Z0-9]+$/,inputErrorMessage:"方案名称只能包含中文、字母和数字"}).then(async({value:o})=>{e.$modal.loading("正在复制检测方案...");try{await L({detectionProtocolsId:t,planName:o}),e.$message.success("复制成功"),n.value&&n.value.getList()}finally{e.$modal.closeLoading()}}).catch(()=>{})},v=async t=>{e.$modal.loading("正在导出检测方案...");try{const o=await P(t.detectionProtocolsId),l=new Blob([o],{type:"application/vnd.ms-excel"}),s=`检测方案_${t.planName}_${t.detectionProtocolsId}_${new Date().getTime()}.xlsx`;if(window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(l,s);else{const a=document.createElement("a");a.href=window.URL.createObjectURL(l),a.download=s,a.style.display="none",document.body.appendChild(a),a.click(),window.URL.revokeObjectURL(a.href),document.body.removeChild(a)}e.$modal.msgSuccess("导出成功")}catch(o){console.error("导出失败:",o),e.$modal.msgError("导出失败，请稍后重试")}finally{e.$modal.closeLoading()}},$=({action:t,row:o})=>{t==="edit"?c.push({name:"DetectionEdit",params:{id:o.detectionProtocolsId}}):t==="configure"?c.push({name:"DetectionConfigure",params:{id:o.detectionProtocolsId}}):t==="copy"?h(o.detectionProtocolsId):t==="export"&&v(o)},D=()=>{i.value.click()},w=async t=>{const o=t.target.files[0];if(!o){e.$modal.msgError("请选择文件");return}if(console.log("选择的文件:",o),!/\.(xlsx|xls)$/.test(o.name.toLowerCase())){e.$modal.msgError("请选择Excel格式的文件(.xlsx, .xls)");return}const s=10*1024*1024;if(o.size>s){e.$modal.msgError("文件大小不能超过10MB");return}const a=new FormData;a.append("file",o),console.log("FormData内容:",a.get("file")),e.$modal.loading("正在导入检测方案...");try{const r=await E(a);console.log("导入响应:",r),r.code===200?(e.$modal.msgSuccess("导入成功"),n.value&&n.value.getList()):e.$modal.msgError(r.msg||"导入失败")}catch(r){console.error("导入失败:",r),e.$modal.msgError("导入失败，请稍后重试")}finally{e.$modal.closeLoading(),i.value.value=""}};return I(()=>{n.value&&n.value.getList()}),(t,o)=>{const l=O("el-button");return R(),T("div",U,[f(k,{ref_key:"formTableRef",ref:n,"form-config":p(g),"table-columns":p(x),operations:b,api:p(C),onAdd:_,onOperation:$},{"form-operations-suffix":y(()=>[f(l,{type:"primary",icon:"Upload",onClick:D},{default:y(()=>[N("导入检测方案")]),_:1}),A("input",{ref_key:"fileInputRef",ref:i,type:"file",accept:".xlsx,.xls",style:{display:"none"},onChange:w},null,544)]),_:1},8,["form-config","table-columns","api"])])}}});export{Z as default};
