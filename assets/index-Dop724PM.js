import{r as s,g as V,o as m,c as w,f as i,w as n,h as d,e as f,x as y,a2 as D,F as A,C as E,S as Z,l as $,T as W,z as q,am as a}from"./index-CBERRbij.js";import{F as G}from"./index-DkNaNI8o.js";import H from"./createOrder-BQj_hlt_.js";import J from"./verification-Ck-tzZgg.js";import{g as K,u as Q,a as X,c as Y,b as ee,d as oe,e as te}from"./createDetectionOrder-JgsFuhJh.js";import"./empty-CNFjmX0R.js";const re={class:"app-container"},ae=["src"],le={style:{color:"#f5222d"}},ne=q({name:"CreateDetectionOrder"}),ye=Object.assign(ne,{setup(se){const p=s(null),h=s(null),b=s(null),g=s(null),u=s(0),v=s(!1),C=s(!1),P=s([{type:"input",label:"VIN码",prop:"vinCode",placeholder:"请输入VIN码",clearable:!0},{type:"input",label:"车牌号",prop:"plateNumber",placeholder:"请输入车牌号",clearable:!0}]),O=s([{type:"index",label:"序号",align:"center"},{prop:"photoType",label:"照片类型",align:"center",slot:"photoType"},{prop:"photoUrl",label:"证件照片",align:"center",slot:"photoUrl"},{prop:"vin",label:"VIN码",align:"center",slot:"vin"},{prop:"licensePlate",label:"车牌号",align:"center"},{prop:"createBy",label:"创建人",align:"center"},{prop:"failedMessage",label:"失败原因",align:"center",showOverflowTooltip:!0,slot:"failedMessage"}]),_=s([{label:"核对",type:"primary",icon:"Check",action:"check",style:e=>e.checked?"background: #f5f5f5; color: #bbb; border-color: #e0e0e0;":""},{label:"删除",type:"danger",icon:"Delete",action:"delete",show:e=>!!e.vinRepeat}]),x=async e=>{try{const o=await K({licensePlate:e.plateNumber||"",vin:e.vinCode||""});return o.code===200?o:{code:o.code,rows:[],total:0}}catch(o){return console.error("获取照片列表失败:",o),{code:500,rows:[],total:0}}},M=e=>{var o;console.log("核对",e),(o=b.value)==null||o.openDialog(e)},R=async e=>{var o;try{if(!(e!=null&&e.id)){a.error("记录ID缺失，无法删除");return}const t=await te(e.id);t&&t.code===200?(a.success("删除成功"),(o=p.value)==null||o.getList()):a.error((t==null?void 0:t.msg)||"删除失败")}catch(t){console.error("删除失败:",t),a.error("删除失败，请重试")}},L=e=>({0:"行驶证",1:"登记证"})[e]||"未知",N=e=>({0:"primary",1:"success"})[e]||"info",U=()=>{var e;u.value=0,(e=g.value)==null||e.click()},I=()=>{var e;u.value=1,(e=g.value)==null||e.click()},B=async e=>{var t;const o=e.target.files[0];if(o){if(!o.name.toLowerCase().endsWith(".zip")){a.error("请选择ZIP格式的压缩包文件");return}if(o.size>50*1024*1024){a.error("文件大小不能超过50MB");return}try{const l=new FormData;l.append("file",o);const r=a({message:"正在上传文件，请稍候...",type:"info",duration:0}),c=await Q(u.value,l);if(r.close(),c.code===200){const T=u.value===0?"行驶证":"登记证";a.success(`${T}压缩包上传成功`),(t=p.value)==null||t.getList()}else a.error(c.msg||"上传失败")}catch(l){console.error("文件上传失败:",l),a.error("文件上传失败，请重试")}finally{e.target.value=""}}},F=async()=>{var e,o;try{const t=await X();(e=h.value)==null||e.openDialog(t)}catch(t){console.error("获取项目数据失败:",t),(o=h.value)==null||o.openDialog(null)}},z=async e=>{var o;try{const t=await Y(e);t&&t.code===200?(o=p.value)==null||o.getList():a.error((t==null?void 0:t.msg)||"订单创建失败")}catch(t){console.error("创建订单失败:",t),a.error("创建订单失败，请重试")}},S=async e=>{var o;try{const t={id:e.id,licensePlate:e.licensePlate||"",vin:e.vin||""},l=await ee(t);l&&l.code===200?(a.success("核对成功"),(o=p.value)==null||o.getList()):a.error((l==null?void 0:l.msg)||"核对失败")}catch(t){console.error("核对请求失败:",t),a.error("核对请求失败，请重试")}},k=({action:e,row:o})=>{switch(console.log("操作:",e,o),e){case"check":M(o);break;case"delete":R(o);break;default:console.warn("未知操作:",e)}},j=async()=>{var e;try{const o=await oe();o&&o.code===200?(a.success("清除成功"),(e=p.value)==null||e.getList()):a.error((o==null?void 0:o.msg)||"清除失败")}catch(o){console.error("清除建单照片失败:",o),a.error("清除失败，请重试")}};return(e,o)=>{const t=V("el-button"),l=V("el-tag");return m(),w("div",re,[i(G,{ref_key:"formTableRef",ref:p,"form-config":P.value,"table-columns":O.value,operations:_.value,api:x,showAdd:!1,onOperation:k},{"form-operations-suffix":n(()=>[i(t,{type:"primary",onClick:U},{default:n(()=>[d("上传行驶证压缩包")]),_:1}),i(t,{type:"primary",onClick:I},{default:n(()=>[d("上传登记证压缩包")]),_:1}),i(t,{type:"success",onClick:F},{default:n(()=>[d("创建订单")]),_:1}),i(t,{type:"danger",onClick:j},{default:n(()=>[d("清除")]),_:1}),f("input",{ref_key:"fileInputRef",ref:g,type:"file",accept:".zip",style:{display:"none"},onChange:B},null,544)]),"table-photoUrl":n(({row:r})=>[f("img",{src:r.photoUrl,style:{width:"80px",height:"50px","object-fit":"cover",cursor:"pointer","border-radius":"4px"}},null,8,ae)]),"table-photoType":n(({row:r})=>[i(l,{type:N(r.photoType)},{default:n(()=>[d(y(L(r.photoType)),1)]),_:2},1032,["type"])]),"table-vin":n(({row:r})=>[f("span",{style:D(r.vinRepeat?"color: #f5222d;":"")},y(r.vin),5)]),"table-failedMessage":n(({row:r})=>[f("span",le,y(r.failedMessage),1)]),"table-operations":n(({row:r})=>[(m(!0),w(A,null,E(_.value,c=>Z((m(),$(t,{key:c.action,type:"text",style:D(c.action==="check"&&r.checked?"color: #bbb !important;":""),onClick:T=>k({action:c.action,row:r})},{default:n(()=>[d(y(c.label),1)]),_:2},1032,["style","onClick"])),[[W,!c.show||c.show(r)]])),128))]),_:1},8,["form-config","table-columns","operations"]),i(H,{ref_key:"createOrderRef",ref:h,modelValue:v.value,"onUpdate:modelValue":o[0]||(o[0]=r=>v.value=r),onConfirm:z},null,8,["modelValue"]),i(J,{ref_key:"verificationRef",ref:b,modelValue:C.value,"onUpdate:modelValue":o[1]||(o[1]=r=>C.value=r),onConfirm:S},null,8,["modelValue"])])}}});export{ye as default};
