import{_ as q,r as k,A as z,g as f,o as v,c as T,f as u,w as l,i as c,F as S,C as F,S as N,l as P,h as C,x as E,T as M,m as G,B as H,z as J,t as K,D as Q}from"./index-CBERRbij.js";import{e as W,b as X,d as Y}from"./detectionCheckbox-Bsfb1_3v.js";const Z=async h=>{const{evaluationPlanId:g}=h;try{return await(g?W:X)(h)}catch(m){throw console.error("保存零部件配置失败:",m),m}},ee={class:"popup"},te=J({name:"ConfigurePopup"}),ae=Object.assign(te,{emits:["success"],setup(h,{expose:g,emit:m}){const{proxy:d}=K(),{detection_type:x}=d.useDict("detection_type"),U=m,i=k(!1),_=k(null),w={detectionProtocolsId:"",partData:[],enablesRestrictedUndetectable:0,vehicleStructure:"",partsId:null,detectionType:[]},o=k({...w}),V=z({enablesRestrictedUndetectable:[{required:!0,message:"请选择拍摄配置",trigger:"change"}],detectionType:[{required:!0,message:"请选择检测类型",trigger:"change"}]}),L=()=>{var t;o.value={...w},(t=_.value)==null||t.resetFields()},I=()=>{i.value=!1},R=t=>{if(!i.value)return!1;setTimeout(()=>{const e=o.value.partData||[],s=t.map(a=>{const r=e.find(p=>p.detectionType===a);return r||{detectionType:a,shootingConfiguration:"",checkData:[]}});o.value.partData=s},500)},O=t=>{var e;return((e=x.value.find(s=>s.value===t))==null?void 0:e.label)||""},j=(t,e)=>{const s=o.value.partData.findIndex(a=>a.detectionType===t);s!==-1&&Object.assign(o.value.partData[s],e)},$=t=>{t&&t.validate(e=>{if(e){d.$modal.loading();const s=o.value.partData.flatMap(a=>a.checkData.map(r=>({...r,shootingConfiguration:a.shootingConfiguration}))).filter(a=>a.assessmentEvaluationCriteriaIdList&&a.assessmentEvaluationCriteriaIdList.length>0);Z({...o.value,partsAssessmentList:s}).then(a=>{a.code===200&&(d.$modal.closeLoading(),d.$modal.msgSuccess("保存成功"),U("success"),I())}).finally(()=>{d.$modal.closeLoading()})}})},A=async t=>{i.value=!0;const{enablesRestrictedUndetectable:e="0",evaluationPlanId:s,detectionProtocolsId:a=""}=t;Q(()=>{var r;if((r=_.value)==null||r.resetFields(),s){const p=t.partsAssessmentList.map(n=>n.detectionType),y=Array.from(new Set(p)),b=B(t.partsAssessmentList);Object.assign(o.value,{evaluationPlanId:s,partsId:t.partsId,vehicleStructure:t.vehicleStructure,detectionType:y,partData:Object.values(b),detectionProtocolsId:a,enablesRestrictedUndetectable:e??0})}else Object.assign(o.value,{partsId:t.partsId,vehicleStructure:t.vehicleStructure,detectionType:[],partData:[],detectionProtocolsId:a,enablesRestrictedUndetectable:e??0})})},B=t=>t.reduce((e,s)=>{const{detectionType:a,shootingConfiguration:r=""}=s;return e[a]||(e[a]={detectionType:a,shootingConfiguration:r,checkData:[]}),e[a].checkData.push(s),e},{});return g({handleOpen:A}),(t,e)=>{const s=f("el-checkbox"),a=f("el-checkbox-group"),r=f("el-form-item"),p=f("el-button"),y=f("el-form"),b=f("el-drawer");return v(),T("div",ee,[u(b,{modelValue:c(i),"onUpdate:modelValue":e[2]||(e[2]=n=>H(i)?i.value=n:null),size:"50%",title:"评测项配置",direction:"rtl",onClosed:L},{default:l(()=>[u(y,{model:c(o),"label-width":"100px",ref_key:"drawerFormRefs",ref:_,rules:c(V),class:"demo-ruleForm"},{default:l(()=>[u(r,{label:"检测类型",prop:"detectionType"},{default:l(()=>[u(a,{modelValue:c(o).detectionType,"onUpdate:modelValue":e[0]||(e[0]=n=>c(o).detectionType=n),onChange:R},{default:l(()=>[(v(!0),T(S,null,F(c(x),n=>N((v(),P(s,{key:n.value,value:n.value},{default:l(()=>[C(E(n.label),1)]),_:2},1032,["value"])),[[M,c(o).vehicleStructure=="1"&&n.value=="common_detection"||c(o).vehicleStructure!="1"]])),128))]),_:1},8,["modelValue"])]),_:1}),c(o).partData&&c(o).partData.length>0?(v(!0),T(S,{key:0},F(c(o).partData,n=>(v(),P(r,{key:n.detectionType,label:O(n.detectionType)},{default:l(()=>[u(Y,{"vehicle-structure":c(o).vehicleStructure,"check-value":n.checkData,"onUpdate:checkValue":D=>n.checkData=D,data:n,"onUpdate:data":D=>j(n.detectionType,D)},null,8,["vehicle-structure","check-value","onUpdate:checkValue","data","onUpdate:data"])]),_:2},1032,["label"]))),128)):G("",!0),u(r,null,{default:l(()=>[u(p,{onClick:I},{default:l(()=>[C("取 消")]),_:1}),u(p,{type:"primary",onClick:e[1]||(e[1]=n=>$(c(_)))},{default:l(()=>[C("保存")]),_:1})]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue"])])}}}),oe=q(ae,[["__scopeId","data-v-d6ff4ae8"]]),re=Object.freeze(Object.defineProperty({__proto__:null,default:oe},Symbol.toStringTag,{value:"Module"}));export{re as a,oe as p,Z as s};
