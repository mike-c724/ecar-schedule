import{l as ne,O as se,e as ie,a as ce,c as de,b as ue,s as pe,d as fe}from"./OrderDetailDialog-DtpCjw7M.js";import{F as me}from"./index-Cj0gErN3.js";import{_ as ve,r as c,A as T,g as f,R as be,o as v,c as M,f as s,w as o,S as x,l as k,h as u,x as ge,m as L,i as he,e as A,F as ye,C as _e,z as ke,am as l,aY as we,E,p as Oe,q as Ie}from"./index-Bz8aCySx.js";const Ue=w=>(Oe("data-v-82fa584c"),w=w(),Ie(),w),xe={class:"app-container"},Se={class:"dialog-footer"},Ve=Ue(()=>A("div",{class:"form-tip"},'提交报告后，工单状态将自动变更为"已完成"',-1)),Ce={class:"dialog-footer"},Re=ke({name:"WorkOrderManagement"}),Le=Object.assign(Re,{setup(w){const W=[{label:"VIN码",prop:"vin",type:"input",placeholder:"请输入VIN码"},{label:"预约人",prop:"name",type:"input",placeholder:"请输入预约人"},{label:"预约电话",prop:"phone",type:"input",placeholder:"请输入预约电话"}],$=[{type:"index",label:"序号",width:"60"},{prop:"channelOrderNo",label:"工单编号",width:"180"},{prop:"vin",label:"VIN码",width:"200"},{prop:"carBrand",label:"车型",width:"150"},{prop:"name",label:"预约人",width:"120"},{prop:"phone",label:"预约电话",width:"150"},{prop:"appointmentTime",label:"预约日期",width:"120"},{prop:"address",label:"预约地址",width:"200"},{prop:"subTime",label:"提交时间",width:"120"},{prop:"orderStatus",label:"状态",width:"100",slot:"status"},{prop:"contentName",label:"检测内容",width:"120"}],j=[{label:"查看",action:"view"},{label:"修改",action:"edit"},{label:"删除",action:"delete"}],m=c({channelOrderId:void 0,subAccountUserId:void 0,detectionProtocolsId:void 0}),O=c([]),q={subAccountUserId:[{required:!0,message:"请选择评估师",trigger:"change"}]},z={reportUrl:[{required:!0,message:"请输入报告链接",trigger:"blur"},{type:"url",message:"请输入有效的URL链接",trigger:"blur"}]},g=T({visible:!1}),h=T({visible:!1}),S=c(null),V=c(null),n=c(null),p=c({channelOrderId:void 0,reportUrl:""});c([{label:"张评估",value:1},{label:"李评估",value:2},{label:"王评估",value:3}]);const J=t=>({0:"待分配",1:"待上门",2:"已完成",3:"已取消"})[t]||"未知状态",Q=t=>({0:"info",1:"warning",2:"success",3:"danger"})[t]||"info",Y=t=>{console.log("搜索参数:",t),y.value={...t}},G=()=>{console.log("重置表单"),y.value={}},H=()=>{l.warning("已禁用添加工单功能")},K=t=>{l.warning("已禁用修改工单功能")},C=c(!1),B=c(""),N=t=>{B.value=t.channelOrderId,C.value=!0},X=t=>{E.confirm("确认删除该工单吗?","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await fe(t.channelOrderId),l.success("删除成功"),n.value&&typeof n.value.getList=="function"&&n.value.getList()}catch(e){console.error("删除工单失败:",e),l.error("删除失败，请重试")}}).catch(()=>{})},Z=({action:t,row:e})=>{switch(t){case"view":N(e);break;case"edit":K();break;case"delete":X(e);break}},ee=({page:t,limit:e})=>{console.log("分页变化:",t,e)},y=c({}),te=()=>{var e,a;y.value=n.value?{...y.value,pageNum:(e=n.value.formData)==null?void 0:e.pageNum,pageSize:(a=n.value.formData)==null?void 0:a.pageSize}:{};const t=we.service({text:"正在导出数据，请稍候...",background:"rgba(0, 0, 0, 0.7)"});ie(y.value).then(d=>{if(d)try{if(d instanceof Blob&&d.type==="application/json"){const i=new FileReader;i.onload=function(){try{const _=JSON.parse(i.result);l.error(_.msg||"导出失败")}catch{l.error("导出失败，服务器返回了无效的数据")}},i.readAsText(d);return}const b=new Blob([d],{type:"application/vnd.ms-excel"}),I="工单数据.xlsx";if(window.navigator.msSaveOrOpenBlob)navigator.msSaveBlob(b,I);else{const i=document.createElement("a");i.href=URL.createObjectURL(b),i.download=I,i.style.display="none",document.body.appendChild(i),i.click(),URL.revokeObjectURL(i.href),document.body.removeChild(i)}l.success("导出成功")}catch(b){console.error("处理导出文件时出错:",b),l.error("处理导出文件时出错")}else l.error("导出失败，未接收到数据")}).catch(d=>{console.error("导出失败:",d),l.error("导出失败，请重试")}).finally(()=>{t.close()})},R=c(!1),D=async(t,e)=>{if(e==="1"){g.visible=!0,m.value.channelOrderId=t.channelOrderId,m.value.detectionProtocolsId=t.detectionProtocolsId;try{R.value=!0;const a=await ce(t.detectionProtocolsId);a.code===200&&Array.isArray(a.data)?O.value=a.data:(O.value=[],l.warning("暂无可选评估师"))}catch(a){console.error("获取评估师列表失败:",a),l.error("获取评估师列表失败"),O.value=[]}finally{R.value=!1}}else e==="2"?(h.visible=!0,p.value.channelOrderId=t.channelOrderId,p.value.reportUrl=""):e==="3"&&E.confirm("确认将该工单标记为已取消吗?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await de(t.channelOrderId,"3"),l.success("工单已取消"),n.value&&typeof n.value.getList=="function"&&n.value.getList()}catch(a){console.error("更新工单状态失败:",a),l.error("操作失败，请重试")}}).catch(()=>{})},re=async()=>{if(!S.value){console.error("分配表单引用不存在");return}S.value.validate(async t=>{if(t)try{await ue(m.value.channelOrderId,m.value.subAccountUserId),l.success("工单分配成功"),g.visible=!1,n.value&&typeof n.value.getList=="function"&&n.value.getList()}catch(e){console.error("分配工单失败:",e),l.error("分配失败，请重试")}})},oe=async()=>{if(!V.value){console.error("报告表单引用不存在");return}V.value.validate(async t=>{if(t)try{if(!ae(p.value.reportUrl)){l.warning("请输入有效的报告链接");return}await pe({channelOrderId:p.value.channelOrderId,reportUrl:p.value.reportUrl}),l.success("报告提交成功，工单已完成"),h.visible=!1,n.value&&typeof n.value.getList=="function"&&n.value.getList()}catch(e){console.error("提交报告失败:",e),l.error("提交失败，请重试")}})},ae=t=>{try{return new URL(t),!0}catch{return!1}};return(t,e)=>{const a=f("el-button"),d=f("el-tag"),b=f("el-option"),I=f("el-select"),i=f("el-form-item"),_=f("el-form"),F=f("el-dialog"),le=f("el-input"),U=be("hasPermi");return v(),M("div",xe,[s(me,{ref_key:"formTableRef",ref:n,"form-config":W,"table-columns":$,operations:j,api:he(ne),"init-api":!0,"show-pagination":!0,"show-add":!1,onSearch:Y,onReset:G,onAdd:H,onOperation:Z,onPagination:ee},{"form-operations-suffix":o(()=>[x((v(),k(a,{type:"primary",plain:"",icon:"Download",onClick:te},{default:o(()=>[u("导出")]),_:1})),[[U,["miniProgram:workOrder:export"]]])]),"table-status":o(({row:r})=>[s(d,{type:Q(r.orderStatus)},{default:o(()=>[u(ge(J(r.orderStatus)),1)]),_:2},1032,["type"])]),"table-operations":o(({row:r})=>[r.orderStatus==="0"?x((v(),k(a,{key:0,type:"primary",text:"",icon:"User",onClick:P=>D(r,"1")},{default:o(()=>[u("分配工单")]),_:2},1032,["onClick"])),[[U,["miniProgram:workOrder:edit"]]]):L("",!0),r.orderStatus==="1"?x((v(),k(a,{key:1,type:"primary",text:"",icon:"Upload",onClick:P=>D(r,"2")},{default:o(()=>[u("提交报告")]),_:2},1032,["onClick"])),[[U,["miniProgram:workOrder:edit"]]]):L("",!0),r.orderStatus==="2"||r.orderStatus==="3"?x((v(),k(a,{key:2,type:"primary",text:"",icon:"View",onClick:P=>N(r)},{default:o(()=>[u("查看")]),_:2},1032,["onClick"])),[[U,["miniProgram:workOrder:query"]]]):L("",!0)]),_:1},8,["api"]),s(F,{title:"分配工单",modelValue:g.visible,"onUpdate:modelValue":e[2]||(e[2]=r=>g.visible=r),width:"500px","append-to-body":""},{footer:o(()=>[A("div",Se,[s(a,{type:"primary",onClick:re},{default:o(()=>[u("确 定")]),_:1}),s(a,{onClick:e[1]||(e[1]=r=>g.visible=!1)},{default:o(()=>[u("取 消")]),_:1})])]),default:o(()=>[s(_,{ref_key:"assignFormRef",ref:S,model:m.value,rules:q,"label-width":"100px"},{default:o(()=>[s(i,{label:"评估师",prop:"subAccountUserId"},{default:o(()=>[s(I,{modelValue:m.value.subAccountUserId,"onUpdate:modelValue":e[0]||(e[0]=r=>m.value.subAccountUserId=r),placeholder:"请选择评估师",loading:R.value},{default:o(()=>[(v(!0),M(ye,null,_e(O.value,r=>(v(),k(b,{key:r.subAccountUserId,label:r.channelSubAccountName,value:r.subAccountUserId},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),s(F,{title:"提交报告",modelValue:h.visible,"onUpdate:modelValue":e[5]||(e[5]=r=>h.visible=r),width:"500px","append-to-body":""},{footer:o(()=>[A("div",Ce,[s(a,{type:"primary",onClick:oe},{default:o(()=>[u("确 定")]),_:1}),s(a,{onClick:e[4]||(e[4]=r=>h.visible=!1)},{default:o(()=>[u("取 消")]),_:1})])]),default:o(()=>[s(_,{ref_key:"reportFormRef",ref:V,model:p.value,rules:z,"label-width":"100px"},{default:o(()=>[s(i,{label:"报告链接",prop:"reportUrl"},{default:o(()=>[s(le,{modelValue:p.value.reportUrl,"onUpdate:modelValue":e[3]||(e[3]=r=>p.value.reportUrl=r),placeholder:"请输入报告链接"},null,8,["modelValue"]),Ve]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),s(se,{visible:C.value,"onUpdate:visible":e[6]||(e[6]=r=>C.value=r),orderId:B.value,title:"工单详情"},null,8,["visible","orderId"])])}}}),De=ve(Le,[["__scopeId","data-v-82fa584c"]]);export{De as default};
