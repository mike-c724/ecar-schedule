import{o as D,e as E}from"./index-CXdL54YQ.js";import{a1 as S,a as N,r as m,v,b as M,K as O,g as U,o as V,c as j,f as y,w as b,h as A,i as z,z as F,t as q,az as H,D as K}from"./index-Bz8aCySx.js";import{F as G}from"./index-Cj0gErN3.js";import{c as J}from"./index-CGdEdH_o.js";import Q from"./statusChangeDialog-DjYD390N.js";import{e as u}from"./jsencrypt-DU2LWEeB.js";import"./jsencrypt.min-C2S-MpmI.js";function W(i){if(i instanceof Array&&i.length>0){const c=S().permissions,r=i,p="*:*:*";return!!c.some(s=>p===s||r.includes(s))}else return console.error(`need roles! Like checkPermi="['system:user:add','system:user:edit']"`),!1}const X={class:"app-container detection"},Y=F({name:"Detection"}),se=Object.assign(Y,{setup(i){const c=N(),{proxy:r}=q();r.useDict("order_type");const p=m([]),a=m(null),s=m(null),w=m({queryStatus:3}),$=v(()=>[{type:"input",label:"订单编号",prop:"orderNo",placeholder:"请输入订单编号"},{type:"select",label:"检测方案",prop:"detectionProtocolsId",placeholder:"请选择检测方案",options:p.value||[]},{type:"input",label:"VIN码",prop:"vin",placeholder:"请输入VIN码"},{type:"daterange",label:"提交时间",prop:"time1",placeholder:"请选择提交时间"},{type:"daterange",label:"审核时间",prop:"time2",placeholder:"请选择审核时间"},{type:"input",label:"审核人",prop:"evaluationUserName",placeholder:"请输入审核人"},{type:"input",label:"车牌号",prop:"licensePlate",placeholder:"请输入车牌号"}]),T=[{prop:"time1",startTime:"submitStartTime",endTime:"submitEndTime"},{prop:"time2",startTime:"evaluationStartTime",endTime:"evaluationEndTime"}],x=v(()=>[{type:"selection",width:50,reserveSelection:!0},{label:"序号",type:"index"},{prop:"orderNo",label:"订单编号"},{prop:"vin",label:"VIN码"},{prop:"planName",label:"检测方案"},{prop:"licensePlate",label:"车牌号"},{label:"车型",formatter:(e,o)=>{var n,d,h;const t=((n=o.orderBase.drivingLicenseInfo)==null?void 0:n.models)||"",l=((d=o.orderBase.drivingLicenseInfo)==null?void 0:d.brand)||"",g=((h=o.orderBase.drivingLicenseInfo)==null?void 0:h.carSeries)||"";return`${l} ${g} ${t}`}},{label:"审核人",formatter:(e,o)=>{var t;return(t=o.orderBase.orderEvaluation)==null?void 0:t.evaluationUserName}},{label:"提交人",formatter:(e,o)=>{var t;return(t=o.orderBase.orderEvaluation)==null?void 0:t.createBy}},{label:"审核时间",formatter:(e,o)=>{var t;return(t=o.orderBase.orderEvaluation)==null?void 0:t.evaluationOrderTime}},{label:"提交时间",formatter:(e,o)=>{var t;return(t=o.orderBase.orderEvaluation)==null?void 0:t.createOrderTime}}]),I=[{label:"查看详情",type:"primary",action:"viewDetail"},{label:"查看报告",type:"primary",action:"viewRecord"},{label:"状态修改",type:"primary",action:"statusChange",show:e=>e.orderType!="6"&&e.orderType!="7"},{label:"复制报告链接",type:"primary",action:"copyReportLink"},{label:"复勘",type:"primary",action:"recheck",show:e=>e.orderType=="6"||e.orderType=="7"}],k={viewDetail:e=>{c.push({path:`/evaluationManagement/evaluated-detail/view/${e.orderId}`})},viewRecord:e=>{if(e.templateType==1){const o=u(e.orderId);window.open(`${window.location.origin}/evaluationManagement/record/view/${o}`)}else if(e.templateType==2){const o=u(e.orderId);window.open(`${window.location.origin}/evaluationManagement/chassisReport/view/${o}`)}else r.$message.error("无此类型报告")},statusChange:e=>{if(!W(["order:change:status"])){r.$message.error("无权限操作");return}s.value.openDialog(e)},copyReportLink:e=>{_(e)},recheck:e=>{r.$confirm("是否确认复勘该订单？","提示",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(async()=>{r.$modal.loading("操作中，请稍后...");const{data:o,msg:t}=await H(e.orderId);r.$message.success(t||"操作成功"),r.$modal.closeLoading(),K(()=>{a.value&&a.value.getList(),o&&c.push({path:`/evaluationManagement/toBeEvaluated/${o}`})})}).catch(o=>{o!=="cancel"&&r.$modal.closeLoading()})}},L=({action:e,row:o})=>{const t=k[e];if(!t){r.$message&&r.$message.error&&r.$message.error("未知操作");return}return t(o)};function _(e){let o="";if(e.templateType==1){const t=u(e.orderId);o=`${window.location.origin}/evaluationManagement/record/view/${t}`}else if(e.templateType==2){const t=u(e.orderId);o=`${window.location.origin}/evaluationManagement/chassisReport/view/${t}`}else{r.$message.error("无此类型报告");return}R(o).then(()=>{r.$message.success("报告链接已复制到剪贴板")}).catch(t=>{r.$message.error("复制失败，请手动复制链接"),console.error("Could not copy text: ",t)})}function R(e){if(navigator.clipboard&&window.isSecureContext)return navigator.clipboard.writeText(e);{let o=document.createElement("textarea");return o.value=e,o.style.position="absolute",o.style.opacity=0,o.style.left="-999999px",o.style.top="-999999px",document.body.appendChild(o),o.focus(),o.select(),new Promise((t,l)=>{document.execCommand("copy")?t():l(),o.remove()})}}const C=()=>{a.value&&a.value.getList()},P=async()=>{const{code:e,data:o}=await J();e===200&&(p.value=o.map(t=>({value:t.detectionProtocolsId,label:t.planName})))},B=async()=>{var o;const e=(o=a.value.refs)==null?void 0:o.table.getSelectionRows();if(console.log(e),!e||e.length===0){r.$message.warning("请先选择要导出的订单");return}r.$modal.loading("导出中，请稍后...");try{const t=e.map(d=>d.orderId),l=await E(t),g=new Blob([l],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),n=document.createElement("a");n.href=window.URL.createObjectURL(g),n.download="订单数据.xlsx",n.click(),window.URL.revokeObjectURL(n.href),f()}catch(t){console.error("导出失败:",t)}finally{r.$modal.closeLoading()}},f=()=>{var e;(e=a.value.refs)==null||e.table.clearSelection()};return M(()=>{P()}),O(()=>{a.value&&a.value.getList()}),(e,o)=>{const t=U("el-button");return V(),j("div",X,[y(G,{ref_key:"formTableRef",ref:a,"form-config":$.value,"table-columns":x.value,operations:I,api:z(D),otherParams:w.value,showAdd:!1,"daterange-map-list":T,onOperation:L,onSearch:f,onReset:f,"row-key":"orderId"},{"form-operations-suffix":b(()=>[y(t,{type:"primary",icon:"Document",onClick:B},{default:b(()=>[A("导出excel")]),_:1})]),_:1},8,["form-config","table-columns","api","otherParams"]),y(Q,{ref_key:"statusChangeDialogRef",ref:s,onRefresh:C},null,512)])}}});export{se as default};
