(function(){"use strict";const a=[];let t=null,u=null;const b=5;let f=0;const C=3e3;let g=null,i=null,d=null;function _(){var w,N;if(g)return g;const o=navigator.userAgent||"",e=`${((w=self.screen)==null?void 0:w.width)||0}x${((N=self.screen)==null?void 0:N.height)||0}`,r=new Date().getTimezoneOffset(),n=navigator.language||"unknown",l=navigator.hardwareConcurrency||1,c=`${o}-${e}-${r}-${n}-${l}`;let s=0;for(let p=0;p<c.length;p++){const $=c.charCodeAt(p);s=(s<<5)-s+$,s=s&s}const m=Math.abs(s).toString(36);return g=m,m}function k(){try{return i&&i.userName?i.userName:"anonymous"}catch{return"anonymouserror"}}function W(){const o=self.location.protocol==="https:"?"wss:":"ws:";let e=null;d&&d.host&&(e=d.host);const r=k(),n=_(),l=`/ws/remind/${r}/${n}`;return`${o}//${e}${l}`}function y(){const o=W();if(console.log("WS_URL",o),t&&(t.readyState===WebSocket.OPEN||t.readyState===WebSocket.CONNECTING)){console.log(t);return}try{if(!o.startsWith("ws://")&&!o.startsWith("wss://"))throw new Error(`WebSocket URL 格式错误: ${o}`);t=new WebSocket(o),t.onopen=()=>{f=0},t.onmessage=e=>{try{const r=JSON.parse(e.data);console.log("收到消息",r),h({type:"server_msg",payload:r})}catch{h({type:"server_msg",payload:e.data})}},t.onclose=e=>{t=null,console.log("WebSocket 连接关闭",e.code),e.code!==1e3&&e.code!==1001&&S()},t.onerror=e=>{t&&t.readyState!==WebSocket.CLOSED&&t.close()}}catch{S()}}function S(){if(!u){if(f>=b){h({type:"ws_error",payload:"已达到最大重连次数，连接失败"});return}f++,u=setTimeout(()=>{u=null,y()},C)}}function h(o){if(!o||typeof o!="object")return;const e=JSON.stringify(o);for(let r=a.length-1;r>=0;r--)try{a[r].postMessage(e)}catch{a.splice(r,1)}}onconnect=o=>{const e=o.ports[0];a.push(e),e.onmessage=r=>{try{const n=typeof r.data=="string"?JSON.parse(r.data):r.data;switch(n==null?void 0:n.type){case"disconnect_me":e.close();const l=a.indexOf(e);l>-1&&a.splice(l,1),a.length===0&&t.close();break;case"start":y();break;case"set_user_info":if(n.payload){const c=i;i=n.payload,(!c||c.userName!==n.payload.userName)&&t&&t.readyState===WebSocket.OPEN&&t.close()}break;case"set_server_config":if(n.payload){console.log("set_server_config",n.payload);const c=d;d=n.payload,(!c||c.host!==n.payload.host)&&t&&t.readyState===WebSocket.OPEN&&t.close()}break;default:}}catch{}},e.start()}})();
