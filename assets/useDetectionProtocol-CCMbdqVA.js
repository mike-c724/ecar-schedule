import{a as oe,r as s,v as $,a0 as se,t as ne,D as le}from"./index-CBERRbij.js";import{g as ue}from"./parts-CyCobads.js";import{g as ie}from"./standard-jYuW60CJ.js";import{e as ce,a as pe,g as de}from"./index-C2-I7XPk.js";import{g as ge}from"./report-CcRmAMD7.js";function Le(C={}){const{proxy:l}=ne();oe();const{isEdit:f=!1,detailId:_=null}=C,{order_type:x,evaluation_mode:M,other_photographs_procedure:R,shooting_plan:q,chassis_scheme:E,detect_bearing:m,vehicle_structure:O,detect_bearing_chassis:z}=l.useDict("order_type","evaluation_mode","other_photographs_procedure","standard_photo","chassis_scheme","shooting_plan","detect_bearing","vehicle_structure","detect_bearing_chassis"),v=s({planName:"",orderType:"",evaluationMode:"",photographsProcedureList:[],standardPhotoTemplateId:"",chassisScheme:"",planRow:"",planColumn:"",reportTemplateId:"",orderScoreStatus:1}),b=s(null),A={planName:[{required:!0,message:"请输入方案名称",trigger:"blur"}],orderType:[{required:!0,message:"请选择订单类型",trigger:"change"}],evaluationMode:[{required:!0,message:"请选择评估模式",trigger:"change"}],photographsProcedureList:[{required:!0,message:"请选择手续照片",trigger:"change"}],standardPhotoTemplateId:[{required:!0,message:"请选择标准照片",trigger:"change"}],reportTemplateId:[{required:!0,message:"请选择流程设置",trigger:"change"}],planRow:[{pattern:/^[1-9][0-9]?$|^99$/,message:"请输入1-99之间的整数",trigger:"blur"}],planColumn:[{pattern:/^[1-9][0-9]?$|^99$/,message:"请输入1-99之间的整数",trigger:"blur"}]},D=s([]),I=s([]),c=s(null),d=s("0"),p=s([]),g=s([]),u=s([]),n=s([]),y=s(!1),L=s(!1),h=s(""),S=$(()=>d.value==="0"?m.value:z.value),j=$(()=>p.value.filter(e=>e.position==="right"));se(()=>m.value,e=>{if(e){const[t]=e;c.value=(t==null?void 0:t.value)||"0"}},{immediate:!0});const k=()=>{ge({pageNum:1,pageSize:999,status:0}).then(e=>{e.code===200&&(I.value=e.rows)})},G=async()=>{y.value=!0;const{rows:e}=await ue({pageSize:999,pageNum:1,partsType:d.value});p.value=e.map(t=>({label:t.partsName,value:t.partsId,position:"right"})),y.value=!1},K=async()=>{const{rows:e}=await ie({pageSize:999,pageNum:1});D.value=e.filter(t=>t.status==="0")},V=async()=>{if(!(!f||!_))try{const{data:e}=await de(_);Object.assign(v.value,e),e.orderScoreStatus!==void 0&&(v.value.orderScoreStatus=Number(e.orderScoreStatus)),u.value=[];const a=e.partsGroupList.map(o=>({detectBearing:o.detectBearing,groupType:o.groupType,protocolsPartsGroupId:o.protocolsPartsGroupId||null,groupName:o.groupName,partsList:o.partsList.map(r=>({label:r.partsName,value:r.partsId,position:"left"}))})).reduce((o,r)=>{const i=`${r.detectBearing}-${r.groupType}`;return o[i]||(o[i]={detectBearing:r.detectBearing,groupType:r.groupType,partsList:[]}),o[i].partsList.push({groupName:r.groupName,options:r.partsList,selectList:[],protocolsPartsGroupId:r.protocolsPartsGroupId||null}),o},{});u.value=Object.values(a),w(),N()}catch(e){console.error(e)}},F=async e=>{g.value=[],n.value=[],await G(),c.value=null;const t=S.value.at(0);c.value=t?t.value:"0",w(),le(()=>{B()})},N=e=>{B()},w=e=>{const t=u.value.flatMap(a=>a.partsList).flatMap(a=>a.options).flatMap(a=>a.value);p.value.forEach(a=>{t.includes(a.value)&&(a.position="left")})},H=(e,t)=>{if(!g.value.length)return!1;const a=p.value.filter(i=>g.value.includes(i.value)?(i.position="left",!0):!1);g.value=[];const o=l.deepClone(e),r=l.deepClone([...o.options,...a]);n.value.splice(t,1,{...o,options:r}),T()},J=()=>{if(!n.value.length)return!1;const e=n.value.flatMap(t=>t.selectList);if(!e.length)return!1;p.value.forEach(t=>{e.includes(t.value)&&(t.position="right")}),g.value=[],n.value.forEach(t=>{t.options=t.options.filter(a=>!e.includes(a.value)),t.selectList=[]}),T()},Q=e=>{const t=n.value[e].options.map(a=>a.value);p.value.forEach(a=>{t.includes(a.value)&&(a.position="right")}),n.value.splice(e,1),T()},T=()=>{const e={detectBearing:c.value,partsList:n.value,groupType:d.value},t=te(c.value,d.value);t===-1?u.value.push(e):u.value.splice(t,1,{...u.value[t],...e})},B=()=>{const e=ee(c.value,d.value);n.value=e?e.partsList:[]},U=()=>{L.value=!0},W=()=>{if(!h.value){l.$message.error("请输入检测部位名称");return}n.value.push({groupName:h.value,options:[],selectList:[]}),L.value=!1},X=()=>{h.value=""},Y=async()=>{if(!await b.value.validate(r=>!!r))return!1;const t=u.value.reduce((r,i)=>{const ae=i.partsList.map(P=>({detectBearing:i.detectBearing,groupName:P.groupName,groupType:i.groupType,partsList:P.options.map(re=>re.value.toString()),protocolsPartsGroupId:P.protocolsPartsGroupId||null}));return r.concat(ae)},[]),a=t.filter(r=>r.groupType=="0"),o=t.filter(r=>r.groupType=="1");try{l.$modal.loading("保存中..."),await(f?ce:pe)({...v.value,partsGroupList:t,bodyPartsGroupList:a,chassisPartsGroupList:o}),l.$message.success("保存成功"),l.$tab.closeOpenPage({name:"Detection"})}catch(r){console.error(r)}finally{l.$modal.closeLoading()}},Z=async()=>{l.$modal.loading("加载中···");try{await G(),await K(),await k(),f&&await V()}catch(e){console.log(e)}finally{l.$modal.closeLoading()}},ee=(e,t)=>u.value.find(a=>a.detectBearing==e&&a.groupType==t),te=(e,t)=>u.value.findIndex(a=>a.detectBearing==e&&a.groupType==t);return{form:v,formRef:b,rules:A,standardPhotoList:D,reportList:I,activeChildIndex:c,activeParentIndex:d,childTabs:S,optionsData:p,selectedOptions:g,partsGroupList:u,partsList:n,optionsRight:j,dialogVisible:L,groupName:h,transferLoading:y,order_type:x,evaluation_mode:M,other_photographs_procedure:R,shooting_plan:q,chassis_scheme:E,detect_bearing:m,vehicle_structure:O,handleParentTabChange:F,handleTabChange:N,handleLeft:H,handleRight:J,handleTransferDelete:Q,handleAdd:U,handleDialogConfirm:W,bindDialogClose:X,handleSave:Y,init:Z}}export{Le as u};
