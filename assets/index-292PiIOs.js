import{P as v,_ as ne,r as g,b as se,A as ce,aD as ie,g as i,R as ue,o as d,c as k,e as P,f as r,w as l,h as _,S as de,l as h,x as pe,F as me,C as he,i as w,aE as E,aF as D,m as fe,z as ve,D as S,am as s,p as ge,q as _e}from"./index-CBERRbij.js";import{F as Pe}from"./index-DkNaNI8o.js";function be(c){return v({url:"/market/detection-protocols-content/list",method:"get",params:c})}function Ce(c){return v({url:"/market/detection-protocols-content/info/"+c,method:"get"})}function ye(c){return v({url:"/market/detection-protocols-content/add-detection-content",method:"post",data:c})}function ke(c){return v({url:"/market/detection-protocols-content/edit-detection-content",method:"put",data:c})}function we(){return v({url:"/product/detection-protocols/list-all",method:"get"})}function Ve(c,V){return v({url:`/market/detection-protocols-content/status-change/${c}/${V}`,method:"get"})}const xe=c=>(ge("data-v-04e478b4"),c=c(),_e(),c),Ie={class:"app-container"},Ne={class:"top-operations"},Ae={class:"status-column"},Ue={class:"image-cell-container"},Le={key:1,class:"no-image"},Oe=["src"],Ee=xe(()=>P("div",{class:"el-upload__tip"},"最多上传3张轮播图片，建议尺寸一致",-1)),De={class:"dialog-footer"},Se=ve({name:"ContentManagement"}),Me=Object.assign(Se,{setup(c){const V=t=>be(t).then(e=>e.code===200?{code:200,rows:e.rows,total:e.total}:Promise.reject(new Error(e.msg||"查询失败"))).catch(e=>(console.error("获取检测方案内容列表失败:",e),{code:500,rows:[],total:0})),M=[{type:"index",label:"序号"},{prop:"contentName",label:"检测方案"},{prop:"contentPhoto.photoOriginal",label:"内容图片",slot:"coverImage"},{prop:"sortNumber",label:"排序"},{prop:"createTime",label:"创建时间"},{prop:"status",label:"状态",slot:"status"}],B=[{label:"编辑",action:"edit"}],x=g([]),F=()=>{we().then(t=>{t.code===200&&t.data&&(x.value=t.data.map(e=>({value:e.detectionProtocolsId.toString(),label:e.planName})))}).catch(t=>{console.error("获取检测方案选项失败:",t)})};se(()=>{F()});const o=g({detectionProtocolsContentId:void 0,detectionProtocolsId:"",contentName:"",contentPhoto:{},carouselChartPhoto:[],reportExampleUrl:"",sortNumber:1}),R={detectionProtocolsId:[{required:!0,message:"请选择检测方案",trigger:"change"}],contentName:[{required:!0,message:"请输入内容标题",trigger:"blur"}],contentPhoto:[{required:!0,message:"请上传套餐图片",trigger:"change"}],sortNumber:[{required:!0,message:"请输入排序",trigger:"blur"}]},p=ce({title:"",visible:!1}),m=g(null),b=g(null),I="/prod-api/market/common/up-photo",N={Authorization:"Bearer "+ie()},u=g(!1),A=()=>{p.title="添加内容",p.visible=!0,o.value={detectionProtocolsContentId:void 0,detectionProtocolsId:"",contentName:"",contentPhoto:{},carouselChartPhoto:[],reportExampleUrl:"",sortNumber:1},Array.isArray(o.value.carouselChartPhoto)||(o.value.carouselChartPhoto=[]),S(()=>{m.value&&m.value.clearValidate()})},U=async t=>{p.title="修改内容",p.visible=!0,await S();try{const e=await Ce(t.detectionProtocolsContentId);if(e.code===200&&e.data)o.value={...e.data},Array.isArray(o.value.carouselChartPhoto)||(o.value.carouselChartPhoto=[]),m.value&&m.value.clearValidate();else throw new Error(e.msg||"获取数据失败")}catch(e){console.error("获取内容数据失败:",e),s.error("获取内容数据失败")}},T=({action:t,row:e})=>{switch(t){case"edit":U(e);break}},q=({page:t,limit:e})=>{console.log("分页变化:",t,e)},z=async()=>{if(!m.value){console.error("表单引用不存在");return}m.value.validate(async t=>{if(t)try{let e;if(o.value.detectionProtocolsContentId?e=await ke(o.value):e=await ye(o.value),e.code===200)s.success(o.value.detectionProtocolsContentId?"修改成功":"新增成功"),p.visible=!1,b.value&&typeof b.value.getList=="function"&&b.value.getList();else throw new Error(e.msg||"操作失败")}catch(e){console.error("提交表单失败:",e),s.error("提交失败，请重试")}})},$=t=>{u.value=!0;const e=t.type==="image/jpeg"||t.type==="image/png",n=t.size/1024/1024<2;return e?n?!0:(u.value=!1,s.error("上传图片大小不能超过 2MB!"),!1):(u.value=!1,s.error("上传图片只能是 JPG 或 PNG 格式!"),!1)},j=(t,e)=>{u.value=!1,t.code===200&&t.data?(o.value.contentPhoto=t.data,s.success("上传成功")):s.error(t.msg||"上传失败")},G=t=>{u.value=!0;const e=t.type.startsWith("image/"),n=t.size/1024/1024<2;return e?n?(Array.isArray(o.value.carouselChartPhoto)||(o.value.carouselChartPhoto=[]),o.value.carouselChartPhoto.length>=3?(u.value=!1,s.warning("最多只能上传3张轮播图片"),!1):!0):(u.value=!1,s.error("图片大小不能超过 2MB!"),!1):(u.value=!1,s.error("只能上传图片文件!"),!1)},J=(t,e,n)=>{u.value=!1,t.code===200&&t.data?(Array.isArray(o.value.carouselChartPhoto)||(o.value.carouselChartPhoto=[]),o.value.carouselChartPhoto.push(t.data),s.success("上传成功"),o.value.carouselChartPhoto.length>3&&(o.value.carouselChartPhoto=o.value.carouselChartPhoto.slice(0,3),s.warning("最多只能上传3张轮播图片"))):s.error(t.msg||"上传失败")},W=t=>{if(!Array.isArray(o.value.carouselChartPhoto)){o.value.carouselChartPhoto=[];return}const e=o.value.carouselChartPhoto.findIndex(n=>n.photoOriginal===t.url);e!==-1&&o.value.carouselChartPhoto.splice(e,1)},H=()=>!Array.isArray(o.value.carouselChartPhoto)||o.value.carouselChartPhoto.length===0?[]:o.value.carouselChartPhoto.map(t=>({name:t.photoName||"图片",url:t.photoOriginal,raw:t})),K=t=>{window.open(t.url)},Q=async(t,e)=>{if(!(!e||!e.detectionProtocolsContentId)){e.statusLoading===void 0&&(e.statusLoading=!1),e.statusLoading=!0;try{const n=await Ve(e.detectionProtocolsContentId,t);if(n.code===200)s.success(t==="0"?"已启用":"已禁用");else throw e.status=t==="0"?"1":"0",new Error(n.msg||"操作失败")}catch(n){console.error("状态变更失败:",n),s.error("状态变更失败，请重试")}finally{e.statusLoading=!1}}};return(t,e)=>{const n=i("el-button"),X=i("el-tag"),Y=i("el-switch"),Z=i("el-image"),ee=i("el-option"),te=i("el-select"),f=i("el-form-item"),L=i("el-input"),C=i("el-icon"),O=i("el-upload"),oe=i("el-input-number"),ae=i("el-form"),le=i("el-dialog"),re=ue("hasPermi");return d(),k("div",Ie,[P("div",Ne,[r(n,{type:"primary",icon:"Plus",onClick:A},{default:l(()=>[_("新增内容")]),_:1})]),r(Pe,{ref_key:"formTableRef",ref:b,"form-config":[],"table-columns":M,operations:B,api:V,"init-api":!0,"show-pagination":!0,"show-add":!1,onAdd:A,onOperation:T,onPagination:q},{"table-operations":l(({row:a})=>[de((d(),h(n,{type:"primary",text:"",icon:"Edit",onClick:y=>U(a)},{default:l(()=>[_("编辑")]),_:2},1032,["onClick"])),[[re,["miniProgram:content:edit"]]])]),"table-status":l(({row:a})=>[P("div",Ae,[r(X,{type:a.status==="0"?"success":"info",class:"status-tag"},{default:l(()=>[_(pe(a.status==="0"?"启用":"禁用"),1)]),_:2},1032,["type"]),r(Y,{modelValue:a.status,"onUpdate:modelValue":y=>a.status=y,"active-value":"0","inactive-value":"1",onChange:y=>Q(y,a),loading:a.statusLoading},null,8,["modelValue","onUpdate:modelValue","onChange","loading"])])]),"table-coverImage":l(({row:a})=>[P("div",Ue,[a.contentPhoto&&a.contentPhoto.photoOriginal?(d(),h(Z,{key:0,src:a.contentPhoto.photoOriginal,style:{width:"120px",height:"70px"},"preview-src-list":[a.contentPhoto.photoOriginal],fit:"cover","preview-teleported":"true"},null,8,["src","preview-src-list"])):(d(),k("div",Le,"暂无图片"))])]),_:1},512),r(le,{title:p.title,modelValue:p.visible,"onUpdate:modelValue":e[5]||(e[5]=a=>p.visible=a),width:"700px","append-to-body":"","destroy-on-close":""},{footer:l(()=>[P("div",De,[r(n,{type:"primary",onClick:z},{default:l(()=>[_("确 定")]),_:1}),r(n,{onClick:e[4]||(e[4]=a=>p.visible=!1)},{default:l(()=>[_("取 消")]),_:1})])]),default:l(()=>[r(ae,{ref_key:"formRef",ref:m,model:o.value,rules:R,"label-width":"100px","validate-on-rule-change":!1},{default:l(()=>[r(f,{label:"检测方案",prop:"detectionProtocolsId"},{default:l(()=>[r(te,{modelValue:o.value.detectionProtocolsId,"onUpdate:modelValue":e[0]||(e[0]=a=>o.value.detectionProtocolsId=a),placeholder:"请选择检测方案",style:{width:"100%"}},{default:l(()=>[(d(!0),k(me,null,he(x.value,a=>(d(),h(ee,{key:a.value,label:a.label,value:a.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),r(f,{label:"内容标题",prop:"contentName"},{default:l(()=>[r(L,{modelValue:o.value.contentName,"onUpdate:modelValue":e[1]||(e[1]=a=>o.value.contentName=a),placeholder:"请输入内容标题"},null,8,["modelValue"])]),_:1}),r(f,{label:"套餐图片",prop:"contentPhoto"},{default:l(()=>[r(O,{class:"cover-uploader",action:I,headers:N,"show-file-list":!1,"on-success":j,"before-upload":$},{default:l(()=>[o.value.contentPhoto&&o.value.contentPhoto.photoOriginal?(d(),k("img",{key:0,src:o.value.contentPhoto.photoOriginal,class:"cover-image"},null,8,Oe)):u.value?(d(),h(C,{key:2,class:"cover-uploader-icon is-loading"},{default:l(()=>[r(w(D))]),_:1})):(d(),h(C,{key:1,class:"cover-uploader-icon"},{default:l(()=>[r(w(E))]),_:1}))]),_:1})]),_:1}),r(f,{label:"轮播图片",prop:"carouselChartPhoto"},{default:l(()=>[r(O,{class:"carousel-uploader",action:I,headers:N,"file-list":H(),"on-success":J,"before-upload":G,"on-remove":W,"on-preview":K,limit:3,"list-type":"picture-card"},{tip:l(()=>[Ee]),default:l(()=>[(o.value.carouselChartPhoto||[]).length<3&&!u.value?(d(),h(C,{key:0},{default:l(()=>[r(w(E))]),_:1})):u.value?(d(),h(C,{key:1,class:"is-loading"},{default:l(()=>[r(w(D))]),_:1})):fe("",!0)]),_:1},8,["file-list"])]),_:1}),r(f,{label:"上传报告样例",prop:"reportExampleUrl"},{default:l(()=>[r(L,{type:"textarea",modelValue:o.value.reportExampleUrl,"onUpdate:modelValue":e[2]||(e[2]=a=>o.value.reportExampleUrl=a),rows:4,placeholder:"请输入报告样例URL地址"},null,8,["modelValue"])]),_:1}),r(f,{label:"排序",prop:"sortNumber"},{default:l(()=>[r(oe,{modelValue:o.value.sortNumber,"onUpdate:modelValue":e[3]||(e[3]=a=>o.value.sortNumber=a),min:1,max:999,style:{width:"200px"}},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["title","modelValue"])])}}}),Re=ne(Me,[["__scopeId","data-v-04e478b4"]]);export{Re as default};
